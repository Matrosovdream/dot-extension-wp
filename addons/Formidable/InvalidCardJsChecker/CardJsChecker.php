<?php

/**
 * Warn users when card number starts with certain blocked prefixes.
 */
final class FrmFormJSCheckCard {

    public static function init(): void {
        //add_action( 'frm_display_form_action', [ __CLASS__, 'maybe_inject_for_form' ], 10, 1 );

        self::maybe_inject_for_form( [] );
    }

    public static function maybe_inject_for_form( array $form ): void {
        add_action( 'wp_footer', [ __CLASS__, 'print_script' ] );
    }

    public static function print_script(): void {
        ?>
        <script>
        (function($){
            $(function(){

                /**
                 * ===== CARD NUMBER PREFIX WARNING =====
                 */

                // 1. Arrays
                var cardNumberIds   = [120, 177];
                var cardWrongMasks = ["400229","400344","401472","402265","403065","403200","403201","403202","403299","403414","403415","403444","403694","404527","404614","404615","406096","408803","408804","409351","409366","410608","410673","411507","412128","412174","412179","412186","412201","412204","412238","412240","412260","412295","412400","412431","412438","412459","412483","412492","412526","412562","412589","412617","412642","412655","412657","412659","412663","412708","412710","412724","412728","412753","412755","412787","412789","412901","412909","412918","412930","412936","412958","412964","412987","413028","413113","413140","413160","413165","413170","413716","414311","414709","415212","415417","415557","416841","419310","420042","420043","421759","421794","422983","423311","423322","423340","424642","424735","425418","426930","426932","426933","426934","426944","426993","426994","426995","426996","427501","427502","427546","429137","429184","429185","430023","430200","430572","431047","431467","431468","431689","431734","433281","438602","438826","438856","438864","440560","440561","442874","443122","443508","449867","449882","463000","463099","463814","464189","464444","464445","465047","465048","465049","465050","465602","466303","466304","466306","466307","466309","466800","468405","468406","468837","468839","471206","473068","473344","474672","474673","474743","475086","475551","475698","477767","478827","478828","478829","479124","479365","480213","480306","480385","480397","482842","486236","487333","487334","493109","493422","510268","510411","510415","510805","510875","510901","511282","511293","511379","511392","511422","511566","511912","512025","512026","512027","512300","512348","512590","512731","512734","512925","512959","513909","514686","514745","514759","514779","514953","515241","515307","515321","515432","515592","515593","515596","515597","515598","515599","515600","515676","515678","517148","517177","517372","517487","517669","517805","517993","517997","517998","518374","518725","518726","520094","520101","520103","520104","520105","520106","520118","520192","520318","520611","520612","521105","521331","521340","521506","522132","522233","522307","522567","522944","522955","523914","524324","525999","526178","526183","526185","526444","526822","527140","527278","527297","527631","528211","528620","528724","528942","529107","529112","529115","529123","529149","529156","529172","529564","529628","530175","531429","531480","531651","532830","532839","533243","534091","534301","537774","537778","537782","537786","537823","538773","538779","538783","539237","539277","539662","539858","540159","540419","540420","540421","540422","540423","540424","540426","540633","540704","540707","540791","540801","540907","541058","541075","541336","541402","541444","541448","541449","541458","541474","541513","541536","541549","541578","541586","541627","541829","542142","542442","542583","542775","543235","543328","543339","543368","543670","543702","543857","543895","543961","544045","544259","544316","544317","544347","544473","544516","544910","545534","545800","546063","546064","546281","546283","546325","546608","546630","546702","546720","547855","548012","548013","548042","548043","548506","548798","548799","548885","548892","548897","548950","548951","548955","549062","549066","549107","549110","549111","549112","549120","549121","549171","549506","549621","549945","550300","551298","551633","551980","551981","552341","552342","552436","552802","552851","552869","553258","553327","553328","554336","554356","555422","555675","556306","557867","558086","558224","558650","558660","558663","558667","558670","558958","559136","600430","639305"];


                // Build selector for all card fields
                var selectors = cardNumberIds.map(function(id){
                    return '[name="item_meta[' + id + '][cc]"]';
                    //return '[name="item_meta[' + id + ']"]';
                });
                var CARD_SELECTOR = selectors.join(',');

                /**
                 * Get or create warning element after the input.
                 */
                function getCardWarningElement($input) {
                    var existing = $input.data('cardWarningEl');
                    if (existing && existing.length) {
                        return existing;
                    }

                    var $msg = $(
                        '<div class="frm-card-warning" ' +
                        'style="margin-top:4px;font-size:13px;color:#b91c1c;' +
                        'background:#fee2e2;border:1px solid #fecaca;padding:6px 8px;' +
                        'border-radius:4px;display:none;"></div>'
                    );
                    $input.after($msg);
                    $input.data('cardWarningEl', $msg);
                    return $msg;
                }

                /**
                 * Check field value and show/hide warning.
                 */
                function handleCardKeyup() {
                    var $field = $(this);

                    // Ignore hidden fields
                    if (!$field.is(':visible') || $field.attr('type') === 'hidden') {
                        var h = $field.data('cardWarningEl');
                        if (h) h.hide();
                        return;
                    }

                    var rawVal = $field.val() || '';
                    var normalized = rawVal.replace(/\s+/g, '');

                    var bad = cardWrongMasks.some(function(mask){
                        return normalized.indexOf(mask) === 0;
                    });

                    var $msg = getCardWarningElement($field);

                    if (bad) {
                        $msg.text(
                            'Weâ€™re currently unable to process cards from this bank. Please try a different card.'
                        );
                        $msg.show();
                    } else {
                        $msg.hide();
                    }
                }

                // Attach delegated listener
                $(document).on('keyup', CARD_SELECTOR, handleCardKeyup);

                // Initial check for pre-filled data
                $(CARD_SELECTOR).each(function(){
                    handleCardKeyup.call(this);
                });

            });
        })(jQuery);
        </script>
        <?php
    }
}

FrmFormJSCheckCard::init();